<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="حسینیه فدائیان ائمه اطهار - مرکز برگزاری مراسم مذهبی و عزاداری اهل بیت علیهم السلام">
  <meta name="keywords" content="حسینیه, ائمه اطهار, مراسم مذهبی, عزاداری, مداحی, دعا">
  <title>حسینیه فدائیان ائمه اطهار | مرکز مراسم مذهبی</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #800000; /* Deep Red */
      --secondary-color: #ffcc00; /* Gold */
      --bg-color: #1a1a1a; /* Dark background */
      --text-color: #f0f0f0; /* Light text */
      --nav-bg: #0d0d0d; /* Even darker for nav/footer */
      --section-bg: #222222; /* Slightly lighter than bg for sections */
      --card-bg: #2c2c2c; /* Card background */
      --border-color: #444444; /* Border color */
      --shadow-light: rgba(0, 0, 0, 0.2);
      --shadow-medium: rgba(0, 0, 0, 0.4);
      --shadow-dark: rgba(0, 0, 0, 0.6);
    }

    .light-mode {
      --primary-color: #9e0000; /* Darker Red */
      --secondary-color: #b8860b; /* DarkGoldenrod */
      --bg-color: #f5f5f5; /* Light background */
      --text-color: #333333; /* Dark text */
      --nav-bg: #e0e0e0; /* Light nav/footer */
      --section-bg: #ffffff; /* White for sections */
      --card-bg: #f9f9f9; /* Lighter card background */
      --border-color: #dddddd; /* Lighter border */
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-medium: rgba(0, 0, 0, 0.15);
      --shadow-dark: rgba(0, 0, 0, 0.2);
    }
    
    body {
      font-family: 'Vazirmatn', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      line-height: 1.8;
      transition: all 0.3s ease;
      padding-bottom: 70px; /* Space for fixed bottom nav */
      overflow-x: hidden; /* Prevent horizontal scroll */
    }
    
    header {
      background-color: var(--primary-color);
      padding: 30px 20px;
      text-align: center;
      position: relative;
      color: white;
      box-shadow: 0 4px 15px var(--shadow-dark);
      background-image: linear-gradient(135deg, var(--primary-color) 0%, darken(var(--primary-color), 10%) 100%);
    }
    
    header h1 {
      margin: 0;
      font-size: 2.8rem;
      font-weight: 700;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.6);
      letter-spacing: 1px;
    }
    
    header p {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-top: 10px;
    }

    .search-box {
      margin: 25px auto 10px;
      max-width: 500px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 14px 45px 14px 20px;
      border-radius: 30px;
      border: none;
      font-size: 1.05rem;
      font-family: 'Vazirmatn', sans-serif;
      background-color: rgba(255, 255, 255, 0.95);
      color: #333;
      box-sizing: border-box;
      box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .search-box input:focus {
        outline: none;
        box-shadow: 0 0 0 3px var(--secondary-color), inset 0 1px 5px rgba(0, 0, 0, 0.2);
    }
    
    .search-box button {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #777;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0;
      transition: color 0.3s ease;
    }

    .search-box button:hover {
        color: #333;
    }
    
    nav {
      background-color: var(--nav-bg);
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      padding: 10px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px var(--shadow-medium);
    }
    
    nav a {
      color: white;
      text-decoration: none;
      margin: 5px 18px;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      padding: 8px 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    nav a:hover {
      color: var(--secondary-color);
      background-color: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    nav a i {
        font-size: 1.2em;
    }
    
    .theme-toggle-nav {
      color: white;
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      margin: 5px 18px;
      transition: all 0.3s ease;
      padding: 8px;
      border-radius: 50%;
    }
    
    .theme-toggle-nav:hover {
      color: var(--secondary-color);
      background-color: rgba(255, 255, 255, 0.15);
    }
    
    .fa-sun { display: none; }
    .fa-moon { display: inline-block; }
    
    body.light-mode .fa-sun { display: inline-block; }
    body.light-mode .fa-moon { display: none; }
    
    .highlight {
      color: var(--secondary-color);
      font-weight: bold;
    }
    
    section {
      padding: 40px 20px;
      max-width: 1100px;
      margin: 30px auto;
      background-color: var(--section-bg);
      border-radius: 12px;
      box-shadow: 0 5px 20px var(--shadow-medium);
      position: relative; /* For background patterns */
      overflow: hidden;
    }

    /* Section background patterns */
    section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 50%),
            radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 50%);
        background-size: 200px 200px;
        opacity: 0.1;
        pointer-events: none;
        z-index: 0;
    }

    section > * {
        position: relative;
        z-index: 1;
    }
    
    h2 {
      color: var(--secondary-color);
      font-size: 2.2rem;
      border-bottom: 3px solid var(--secondary-color);
      padding-bottom: 15px;
      margin-top: 0;
      text-align: center;
      position: relative;
      margin-bottom: 30px;
    }

    h2::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background-color: var(--primary-color);
        border-radius: 5px;
    }
    
    h3 {
      color: var(--secondary-color);
      font-size: 1.5rem;
      margin-bottom: 15px;
    }
    
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 25px;
      margin-top: 25px;
    }
    
    .gallery-item {
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 6px 15px var(--shadow-light);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 220px;
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    
    .gallery-item:hover {
      transform: translateY(-8px);
      box-shadow: 0 10px 25px var(--shadow-medium);
    }
    
    .gallery img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    
    .gallery-item:hover img {
      transform: scale(1.08);
    }
    
    .program-schedule {
      background-color: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      margin-top: 25px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 10px var(--shadow-light);
    }
    
    .program-day {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px dashed var(--border-color);
    }
    
    .program-day:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .program-day h3 {
      color: var(--secondary-color);
      margin-bottom: 10px;
      font-size: 1.6rem;
    }

    .program-day p {
        margin: 5px 0;
    }
    
    form {
      display: flex;
      flex-direction: column;
      gap: 18px;
      max-width: 700px;
      margin: 25px auto 0;
      padding: 25px;
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 4px 10px var(--shadow-light);
      border: 1px solid var(--border-color);
    }
    
    input, textarea, button {
      padding: 14px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 1.05rem;
      font-family: 'Vazirmatn', sans-serif;
      background-color: var(--bg-color); /* Slightly different from card-bg */
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    input::placeholder, textarea::placeholder {
        color: #999;
    }

    input:focus, textarea:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(var(--secondary-color-rgb), 0.3);
    }
    
    textarea {
      resize: vertical;
      min-height: 120px;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    button:hover {
      background-color: darken(var(--primary-color), 10%);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(var(--primary-color-rgb), 0.4);
    }
    
    .social-links {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin: 25px 0;
      justify-content: center;
    }
    
    .social-link {
      display: flex;
      align-items: center;
      color: white;
      text-decoration: none;
      background-color: var(--primary-color);
      padding: 12px 20px;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 2px 5px var(--shadow-light);
    }
    
    .social-link:hover {
      background-color: darken(var(--primary-color), 10%);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px var(--shadow-medium);
    }
    
    .social-link i {
      margin-left: 10px;
      font-size: 1.3rem;
    }
    
    footer {
      background-color: var(--nav-bg);
      color: #aaa;
      text-align: center;
      padding: 30px 20px 80px; /* Extra padding for bottom nav */
      margin-top: 50px;
      box-shadow: 0 -2px 10px var(--shadow-dark);
    }
    
    .back-to-top {
      position: fixed;
      bottom: 90px; /* Above bottom nav */
      left: 20px;
      background-color: var(--primary-color);
      color: white;
      width: 55px;
      height: 55px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.6rem;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 99;
      border: none;
      box-shadow: 0 4px 10px var(--shadow-medium);
    }
    
    .back-to-top.visible {
      opacity: 1;
      visibility: visible;
    }
    
    /* Media Containers (Madahi/Mowludi) */
    .media-container {
      background-color: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      margin-top: 25px;
      border: 1px solid var(--border-color);
      position: relative;
      box-shadow: 0 6px 15px var(--shadow-light);
    }
    
    .media-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .media-title {
      color: var(--secondary-color);
      font-size: 1.8rem;
      margin: 0;
    }
    
    .media-controls {
      color: var(--secondary-color);
      font-size: 1.5rem;
    }
    
    .media-frame {
      width: 100%;
      height: 450px; /* Adjusted height for better viewing */
      border: none;
      border-radius: 8px;
      background-color: #000;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }
    
    /* Bottom Navigation Bar */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--nav-bg);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 1000;
      box-shadow: 0 -5px 20px var(--shadow-dark);
      border-top: 1px solid var(--border-color);
    }
    
    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      padding: 8px 10px;
      border-radius: 10px;
      min-width: 60px;
      text-align: center;
    }
    
    .bottom-nav-item i {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }
    
    .bottom-nav-item:hover {
      background-color: rgba(255, 255, 255, 0.15);
      color: var(--secondary-color);
    }
    
    .bottom-nav-item.active {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 2px 8px rgba(var(--primary-color-rgb), 0.5);
    }
    
    /* Overlays (Quran, Calendar, Feed, Haram Online) */
    .overlay {
      position: fixed;
      bottom: 0; /* Changed from 70px to 0 to cover full screen above nav */
      left: 0;
      right: 0;
      top: 0; /* Full height */
      background-color: rgba(var(--bg-color-rgb), 0.95); /* Semi-transparent background */
      padding: 20px;
      border-radius: 15px 15px 0 0;
      box-shadow: 0 -5px 25px var(--shadow-dark);
      transform: translateY(100%);
      transition: transform 0.4s ease-out, background-color 0.3s ease;
      z-index: 1001; /* Above bottom nav */
      display: flex;
      flex-direction: column;
      overflow: hidden; /* For scrollable content */
    }
    
    .overlay.show {
      transform: translateY(0);
    }
    
    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0; /* Prevent header from shrinking */
    }
    
    .overlay-title {
      color: var(--secondary-color);
      margin: 0;
      font-size: 1.8rem;
    }
    
    .close-overlay {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.3s ease, transform 0.2s ease;
    }

    .close-overlay:hover {
        color: var(--primary-color);
        transform: rotate(90deg);
    }
    
    .quran-search {
      display: flex;
      margin: 0 10px;
      flex-grow: 1;
      gap: 10px;
    }
    
    .quran-search input {
      flex-grow: 1;
      padding: 10px 15px;
      border-radius: 25px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      font-family: 'Vazirmatn', sans-serif;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .quran-search button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 18px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }

    .quran-search button:hover {
        background-color: darken(var(--primary-color), 10%);
    }
    
    .quran-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap; /* Allow wrapping on small screens */
    }
    
    .quran-controls label {
        color: var(--text-color);
        align-self: center;
    }

    .quran-controls select {
      flex: 1;
      min-width: 150px;
      padding: 10px;
      border-radius: 8px;
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      font-family: 'Vazirmatn', sans-serif;
      appearance: none; /* Remove default arrow */
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23F0F0F0%22%20d%3D%22M287%2C114.7L154.7%2C247.1c-2.7%2C2.7-6.2%2C4-9.5%2C4s-6.8-1.3-9.5-4L5.4%2C114.7c-3.1-3.1-4-7.6-2.5-11.5c1.5-3.9%2C5.3-6.5%2C9.5-6.5h277.6c4.2%2C0%2C8%2C2.6%2C9.5%2C6.5C291%2C107.1%2C290.1%2C111.6%2C287%2C114.7z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: left 10px center;
      background-size: 15px;
      padding-left: 35px; /* Space for custom arrow */
    }
    
    .quran-content {
        flex-grow: 1; /* Allow content to take available space */
        overflow-y: auto; /* Make content scrollable */
        padding-right: 10px; /* For scrollbar */
    }

    .verse-container {
      margin-bottom: 18px;
      padding: 15px;
      border-radius: 10px;
      background-color: var(--card-bg);
      box-shadow: 0 2px 8px var(--shadow-light);
      border: 1px solid var(--border-color);
    }
    
    .verse-arabic {
      font-size: 1.6rem;
      text-align: right;
      line-height: 2.2;
      color: var(--text-color);
      margin-bottom: 10px;
    }
    
    .verse-translation {
      font-size: 1rem;
      text-align: right;
      color: #ccc;
      border-top: 1px dashed var(--border-color);
      padding-top: 10px;
      margin-top: 10px;
      transition: opacity 0.3s ease;
    }

    .verse-english-translation {
      font-size: 1rem;
      text-align: left; /* Changed to left for LTR English */
      color: #bbb;
      border-top: 1px dashed var(--border-color);
      padding-top: 10px;
      margin-top: 10px;
      transition: opacity 0.3s ease;
    }
    
    .verse-number {
      display: inline-block;
      width: 30px;
      height: 30px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 30px;
      font-size: 0.9rem;
      margin-left: 8px;
      flex-shrink: 0;
    }
    
    .loading-spinner {
      text-align: center;
      padding: 30px;
      color: var(--secondary-color);
    }
    
    .loading-spinner i {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }
    
    /* Calendar specific styles */
    .month-navigator {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .month-navigator button {
      background: var(--primary-color);
      color: white;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .month-navigator button:hover {
        background-color: darken(var(--primary-color), 10%);
    }
    
    #currentMonth {
      font-size: 1.3rem;
      color: var(--secondary-color);
      font-weight: 500;
    }
    
    .city-selector {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }
    
    .city-selector input {
      flex-grow: 1;
      padding: 10px 15px;
      border-radius: 8px;
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      font-family: 'Vazirmatn', sans-serif;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .city-selector button {
      padding: 10px 20px;
      border-radius: 8px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .city-selector button:hover {
        background-color: darken(var(--primary-color), 10%);
    }
    
    .prayer-times {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px dashed var(--border-color);
      flex-shrink: 0;
    }
    
    .prayer-time {
      background-color: var(--card-bg);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px var(--shadow-light);
    }
    
    .prayer-time span:first-child {
      display: block;
      font-size: 0.9rem;
      color: var(--secondary-color);
      margin-bottom: 5px;
    }
    
    .prayer-time span:last-child {
      display: block;
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--text-color);
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      flex-grow: 1; /* Calendar grid takes remaining space */
      overflow-y: auto;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background-color: var(--card-bg);
      font-size: 1rem;
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: all 0.2s ease;
      box-shadow: 0 1px 4px var(--shadow-light);
    }

    .calendar-day:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px var(--shadow-medium);
    }
    
    .calendar-day.today {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.5);
    }
    
    .calendar-day.other-month {
      opacity: 0.6;
      background-color: var(--bg-color);
      color: #999;
    }
    
    .calendar-day-name {
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      color: var(--secondary-color);
      font-size: 1.1rem;
    }
    
    /* Admin Activator Button */
    .admin-activator {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: var(--primary-color);
      color: white;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.3rem;
      cursor: pointer;
      z-index: 1000;
      border: none;
      box-shadow: 0 2px 8px var(--shadow-medium);
      transition: all 0.3s ease;
    }

    .admin-activator:hover {
        transform: scale(1.1);
        background-color: darken(var(--primary-color), 10%);
        box-shadow: 0 5px 15px var(--shadow-dark);
    }
    
    /* Settings content (inside overlays) */
    .settings-content {
      padding: 20px;
    }
    
    .feed-post {
      background-color: var(--card-bg);
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: 0 4px 10px var(--shadow-light);
      padding: 20px;
      border: 1px solid var(--border-color);
    }
    
    .post-header {
      display: flex;
      align-items: center;
      padding-bottom: 15px;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .post-header h4 {
      margin: 0;
      color: var(--secondary-color);
      font-size: 1.5rem;
    }

    .post-header small {
        color: #aaa;
        font-size: 0.9rem;
        display: block;
        margin-top: 5px;
    }
    
    .post-content {
        margin-bottom: 15px;
        color: var(--text-color);
    }

    .post-image {
      width: 100%;
      max-height: 400px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid var(--border-color);
    }
    
    .surah-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .verse-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    
    .verse-actions button {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      font-size: 0.95rem;
      border-radius: 8px;
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .verse-actions button:hover {
        background-color: var(--primary-color);
        color: white;
        box-shadow: 0 2px 8px rgba(var(--primary-color-rgb), 0.3);
    }

    /* Styles for the new "Feed" section */
    .feed-container {
        padding: 10px;
        flex-grow: 1;
        overflow-y: auto;
    }

    .add-post-btn {
        text-align: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px dashed var(--border-color);
        flex-shrink: 0;
    }

    .add-post-btn button {
        width: auto;
        padding: 12px 25px;
        border-radius: 30px;
        font-size: 1.05rem;
        box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.3);
    }

    /* Haram Online section */
    .haram-stream-container {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      height: 0;
      overflow: hidden;
      border-radius: 12px;
      background-color: var(--card-bg);
      box-shadow: 0 6px 15px var(--shadow-medium);
      border: 1px solid var(--border-color);
    }

    .haram-stream-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      background-color: #000;
    }

    #haramStreamPlaceholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: var(--card-bg);
      color: var(--text-color);
      border-radius: 12px;
      font-size: 1.2rem;
      text-align: center;
      padding: 20px;
    }

    #haramStreamPlaceholder i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: var(--secondary-color);
    }
    
    .haram-controls {
      margin-bottom: 20px;
      flex-shrink: 0;
    }

    .haram-controls select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      font-family: 'Vazirmatn', sans-serif;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23F0F0F0%22%20d%3D%22M287%2C114.7L154.7%2C247.1c-2.7%2C2.7-6.2%2C4-9.5%2C4s-6.8-1.3-9.5-4L5.4%2C114.7c-3.1-3.1-4-7.6-2.5-11.5c1.5-3.9%2C5.3-6.5%2C9.5-6.5h277.6c4.2%2C0%2C8%2C2.6%2C9.5%2C6.5C291%2C107.1%2C290.1%2C111.6%2C287%2C114.7z%22%2F%3E%3C%2Fsvg%3E');
      background-repeat: no-repeat;
      background-position: left 15px center;
      background-size: 18px;
      padding-left: 45px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .haram-controls select:focus {
        outline: none;
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(var(--secondary-color-rgb), 0.3);
    }

    /* Utility classes for colors */
    .primary-text { color: var(--primary-color); }
    .secondary-text { color: var(--secondary-color); }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2.2rem;
      }
      
      nav a {
        font-size: 1rem;
        margin: 5px 8px;
        padding: 6px 10px;
        gap: 5px;
      }

      nav a i {
          font-size: 1em;
      }
      
      .theme-toggle-nav {
        font-size: 1.2rem;
        margin: 5px 8px;
        padding: 6px;
      }

      section {
        padding: 30px 15px;
        margin: 20px auto;
      }
      
      h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      h3 {
          font-size: 1.3rem;
      }
      
      .gallery {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .media-frame {
        height: 300px;
      }
      
      .bottom-nav-item {
        font-size: 0.75rem;
        padding: 6px 5px;
        min-width: 50px;
      }
      
      .bottom-nav-item i {
        font-size: 1.3rem;
        margin-bottom: 3px;
      }
      
      .overlay-title {
        font-size: 1.5rem;
      }

      .quran-search {
          flex-direction: column;
          gap: 10px;
      }

      .quran-search input, .quran-search button {
          width: 100%;
      }
      
      .quran-controls {
        flex-direction: column;
        gap: 10px;
      }
      
      .verse-arabic {
        font-size: 1.4rem;
      }

      .verse-translation, .verse-english-translation {
          font-size: 0.9rem;
      }
      
      .verse-actions {
        flex-direction: column;
        gap: 8px;
      }

      .verse-actions button {
          font-size: 0.9rem;
          padding: 8px;
      }

      .month-navigator {
          flex-wrap: wrap;
          font-size: 1.1rem;
      }

      .prayer-times {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
      }

      .city-selector {
          flex-direction: column;
          gap: 10px;
      }

      form {
          padding: 20px;
          gap: 15px;
      }

      .social-link {
          font-size: 0.9rem;
          padding: 10px 15px;
      }
    }

    @media (max-width: 480px) {
        header h1 {
            font-size: 1.8rem;
        }
        header p {
            font-size: 1rem;
        }
        nav {
            padding: 5px 0;
        }
        nav a {
            margin: 3px 5px;
            font-size: 0.9rem;
        }
        .theme-toggle-nav {
            font-size: 1rem;
        }
        section {
            padding: 20px 10px;
        }
        h2 {
            font-size: 1.6rem;
        }
        .bottom-nav-item span {
            display: block; /* Show text on small phones too */
        }
        .bottom-nav-item {
            font-size: 0.7rem;
        }
        .overlay-title {
            font-size: 1.3rem;
        }
        .close-overlay {
            font-size: 1.3rem;
        }
        .quran-controls {
            flex-direction: column;
        }
        .quran-controls select {
            min-width: unset;
        }
        .prayer-time span:last-child {
            font-size: 1.1rem;
        }
        .calendar-day {
            font-size: 0.85rem;
        }
    }
  </style>
</head>
<body>

<header>
  <h1>حسینیه فدائیان ائمه اطهار (ع)</h1>
  <p>تأسیس ۱۳۵۰</p>
  <div class="search-box">
    <input type="text" placeholder="جستجو در سایت...">
    <button type="submit"><i class="fas fa-search"></i></button>
  </div>
</header>

<nav>
  <a href="#about"><i class="fas fa-info-circle"></i> درباره ما</a>
  <a href="#programs"><i class="fas fa-calendar-alt"></i> برنامه‌ها</a>
  <a href="#madahi"><i class="fas fa-music"></i> مداحی</a>
  <a href="#mowludi"><i class="fas fa-microphone-alt"></i> مولودی</a>
  <a href="#gallery"><i class="fas fa-images"></i> گالری</a>
  <a href="#contact"><i class="fas fa-envelope"></i> تماس با ما</a>
  <button class="theme-toggle-nav" onclick="toggleTheme()">
    <i class="fas fa-moon"></i>
    <i class="fas fa-sun"></i>
  </button>
</nav>

<section id="about">
  <h2>درباره حسینیه</h2>
  <p>
    حسینیه فدائیان ائمه اطهار مکانی برای برگزاری مراسم‌های مذهبی، عزاداری، سخنرانی‌های دینی، جلسات قرائت دعا و جلسات معرفتی برای عاشقان اهل بیت (ع) می‌باشد. این حسینیه با سابقه‌ای درخشان از سال ۱۳۵۰ در برگزاری مراسم‌های مذهبی، میزبان دلسوختگان و محبین اهل بیت علیهم‌السلام است.
  </p>
  <p>
    برنامه‌های متنوعی از جمله جلسات تفسیر قرآن، مراسم عزاداری ماه‌های محرم و صفر، جلسات دعای کمیل، توسل و ندبه در این مکان برگزار می‌شود.
  </p>
</section>

<section id="programs">
  <h2>برنامه‌های هفتگی</h2>
  <div class="program-schedule">
    <div class="program-day">
      <h3>یکشنبه‌ها</h3>
      <p>از اذان مغرب:</p>
      <p>اقامه نماز جماعت: حاج آقا دشتی</p>
      <p>قرائت زیارت عاشورا: آقای مهدی اسدی</p>
      <p>قرائت قرآن کریم: حاج آقا مهدی دشتی</p>
      <p>مداحی: آقای هاشم بشیری</p>
    </div>
    <div class="program-day">
      <h3>پنجشنبه‌ها</h3>
      <p>مکان: خیابان کارگر جنوبی، بین میدان پاستور و خیابان آذربایجان نبش کوچه روشن پلاک ۱ طبقه دوم</p>
      <p><span class="highlight">زنگ زده شود</span> از ساعت ۲۱ الی ۱۲ بامداد</p>
    </div>
  </div>
</section>

<section id="madahi">
  <h2>مداحی‌ها</h2>
  <p>مجموعه‌ای از مداحی‌های برگزیده مراسمات حسینیه:</p>
  
  <div class="media-container">
    <div class="media-header">
      <h3 class="media-title">آخرین مداحی‌ها</h3>
      <div class="media-controls">
        <i class="fas fa-headphones"></i>
      </div>
    </div>
    <iframe src="https://kashoob.com/audios/type/madahi" 
            class="media-frame"
            sandbox="allow-same-origin allow-scripts allow-popups"
            loading="lazy"
            referrerpolicy="no-referrer">
    </iframe>
  </div>
</section>

<section id="mowludi">
  <h2>مولودی‌ها</h2>
  <p>مجموعه‌ای از مولودی‌های خوانده شده در مراسمات حسینیه:</p>
  
  <div class="media-container">
    <div class="media-header">
      <h3 class="media-title">آخرین مولودی‌ها</h3>
      <div class="media-controls">
        <i class="fas fa-music"></i>
      </div>
    </div>
    <iframe src="https://kashoob.com/audios/sabk" 
            class="media-frame"
            sandbox="allow-same-origin allow-scripts allow-popups"
            loading="lazy"
            referrerpolicy="no-referrer">
    </iframe>
  </div>
</section>

<section id="gallery">
  <h2>گالری تصاویر</h2>
  <div class="gallery">
    <div class="gallery-item">
      <img src="https://via.placeholder.com/300x220/800000/FFFFFF?text=Image+1" alt="مراسم عزاداری محرم">
    </div>
    <div class="gallery-item">
      <img src="https://via.placeholder.com/300x220/800000/FFFFFF?text=Image+2" alt="جلسه دعای توسل">
    </div>
    <div class="gallery-item">
      <img src="https://via.placeholder.com/300x220/800000/FFFFFF?text=Image+3" alt="عاشورای حسینی">
    </div>
    <div class="gallery-item">
      <img src="https://via.placeholder.com/300x220/800000/FFFFFF?text=Image+4" alt="سخنرانی دینی">
    </div>
  </div>
</section>

<section id="contact">
  <h2>تماس با ما</h2>
  <p><i class="fas fa-map-marker-alt primary-text"></i> آدرس: خیابان کارگر جنوبی، بین میدان پاستور و خیابان آذربایجان نبش کوچه روشن</p>
  <div class="navigation-links" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
    <a href="https://nshn.ir/8asbvg7j2xO5N-" target="_blank" class="social-link" style="background-color: #5cb85c;">
      <i class="fas fa-directions"></i> مسیریابی با نشان
    </a>
    <a href="https://balad.ir/p/3S1Gx4hJNsNOlw" target="_blank" class="social-link" style="background-color: #007bff;">
      <i class="fas fa-directions"></i> مسیریابی با بلد
    </a>
  </div>

  <h3><i class="fas fa-share-alt primary-text"></i> شبکه‌های اجتماعی</h3>
  <div class="social-links">
    <a href="https://t.me/Heiat_imams_athar" target="_blank" class="social-link" style="background-color: #26A5E4;">
      <i class="fab fa-telegram-plane"></i> تلگرام
    </a>
    <a href="https://splus.ir/heiat_imams_athar" target="_blank" class="social-link" style="background-color: #5d4393;">
        <i class="fas fa-comment-alt"></i> سروش پلاس
    </a>
    <a href="https://eitaa.com/Heiat_imams_athar" target="_blank" class="social-link" style="background-color: #F87D33;">
      <i class="fas fa-paper-plane"></i> ایتا
    </a>
    <a href="https://instagram.com/Heiat_imams_athar" target="_blank" class="social-link" style="background-color: #E4405F;">
      <i class="fab fa-instagram"></i> اینستاگرام
    </a>
    <a href="https://aparat.com/Heiat_imams_athar" target="_blank" class="social-link" style="background-color: #ED1C24;">
      <i class="fab fa-youtube"></i> آپارات
    </a>
    <a href="https://whatsapp.com/channel/0029Vb5eNUQDJ6H26kPvNK1W" target="_blank" class="social-link" style="background-color: #25D366;">
      <i class="fab fa-whatsapp"></i> واتساپ
    </a>
    <a href="https://ble.ir/Heiat_imams_athar" target="_blank" class="social-link" style="background-color: #3150A6;">
      <i class="fas fa-bell"></i> بله
    </a>
  </div>

  <h3><i class="fas fa-comments primary-text"></i> ارتباط مستقیم</h3>
  <p>جهت ارتباط با ما در یکی از پیام‌رسان های زیر به ما پیام دهید:</p>
  <div class="social-links">
    <a href="https://t.me/pr_heiat" target="_blank" class="social-link" style="background-color: #26A5E4;">
      <i class="fab fa-telegram-plane"></i> تلگرام
    </a>
    <a href="https://eitaa.ir/pr_heiat" target="_blank" class="social-link" style="background-color: #F87D33;">
      <i class="fas fa-paper-plane"></i> ایتا
    </a>
    <a href="https://ble.ir/pr_heiat" target="_blank" class="social-link" style="background-color: #3150A6;">
      <i class="fas fa-bell"></i> بله
    </a>
  </div>
</section>

<footer>
  <p>&copy; ۱۴۰۴ حسینیه فدائیان ائمه اطهار | تأسیس ۱۳۵۰ | تمامی حقوق محفوظ است</p>
  <p>طراحی و توسعه مهیار اسدی</p>
</footer>

<button class="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
  <i class="fas fa-arrow-up"></i>
</button>

<div class="bottom-nav">
  <a href="#calendar" class="bottom-nav-item" onclick="showCalendar()">
    <i class="fas fa-calendar"></i>
    <span>تقویم</span>
  </a>
  <a href="#" class="bottom-nav-item" onclick="scrollToTop()">
    <i class="fas fa-home"></i>
    <span>خانه</span>
  </a>
  <a href="#quran" class="bottom-nav-item" onclick="showQuranSection()">
    <i class="fas fa-quran"></i>
    <span>قرآن</span>
  </a>
  <a href="#feed" class="bottom-nav-item" onclick="toggleFeed()">
    <i class="fas fa-newspaper"></i>
    <span>اطلاع‌رسانی</span>
  </a>
  <a href="#haram" class="bottom-nav-item" onclick="showHaramOnlineSection()">
    <i class="fas fa-mosque"></i>
    <span>حرم آنلاین</span>
  </a>
</div>

<div class="overlay" id="quranOverlay">
  <div class="overlay-header">
    <h3 class="overlay-title">قرآن کریم</h3>
    <div class="quran-search">
      <input type="text" id="quranSearch" placeholder="جستجوی متن، یا 'بقره ۵' یا '2:5'">
      <button onclick="searchInQuran()"><i class="fas fa-search"></i></button>
    </div>
    <button class="close-overlay" onclick="toggleOverlay('quranOverlay')">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="quran-controls">
    <label for="surahSelectInner">انتخاب سوره:</label>
    <select id="surahSelectInner" onchange="loadSurah(this.value)">
      <option value="">-- انتخاب سوره --</option>
    </select>
    <label for="juzSelect">انتخاب جزء:</label>
    <select id="juzSelect" onchange="loadJuz(this.value)">
      <option value="">-- انتخاب جزء --</option>
    </select>
  </div>
  
  <div class="quran-content" id="quranContent">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>در حال بارگذاری...</p>
    </div>
  </div>
  
  <div class="verse-actions">
    <button onclick="toggleTranslation('persian')"><i class="fas fa-language"></i> نمایش/عدم نمایش ترجمه فارسی</button>
    <button onclick="toggleTranslation('english')"><i class="fas fa-language"></i> نمایش/عدم نمایش ترجمه انگلیسی</button>
    <button onclick="toggleAudio()"><i class="fas fa-volume-up"></i> پخش صوتی</button>
    <button onclick="bookmarkVerse()"><i class="fas fa-bookmark"></i> ذخیره</button>
  </div>
</div>

<div class="overlay" id="calendarOverlay">
  <div class="overlay-header">
    <h3 class="overlay-title">تقویم و اوقات شرعی</h3>
    <div class="month-navigator">
      <button onclick="changeMonth(-1)"><i class="fas fa-chevron-right"></i></button>
      <span id="currentMonth"></span>
      <button onclick="changeMonth(1)"><i class="fas fa-chevron-left"></i></button>
    </div>
    <button class="close-overlay" onclick="toggleOverlay('calendarOverlay')">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="city-selector">
    <input type="text" id="cityInput" placeholder="نام شهر" value="Tehran">
    <input type="text" id="countryInput" placeholder="نام کشور" value="Iran">
    <button onclick="fetchPrayerTimes()">اعمال</button>
  </div>

  <div class="prayer-times" id="prayerTimes">
    <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>در حال دریافت اوقات شرعی...</p>
    </div>
  </div>
  
  <div class="calendar-grid" id="calendarGrid">
    </div>
</div>

<div class="overlay" id="haramOnlineOverlay">
  <div class="overlay-header">
    <h3 class="overlay-title">حرم آنلاین</h3>
    <button class="close-overlay" onclick="toggleOverlay('haramOnlineOverlay')">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="haram-controls">
    <select id="haramSelect" onchange="loadHaramStream(this.value)">
      <option value="">-- انتخاب حرم/مکان --</option>
      <option value="https://heyatonline.ir/hm/karbala/">کربلا (بین‌الحرمین)</option>
      <option value="https://heyatonline.ir/hm/1/">حرم امام رضا (ع) - صحن انقلاب</option>
      <option value="https://heyatonline.ir/hm/2/">حرم امام رضا (ع) - صحن آزادی</option>
      <option value="https://heyatonline.ir/hm/3/">حرم امام رضا (ع) - صحن جامع رضوی</option>
      <option value="https://heyatonline.ir/hm/4/">حرم حضرت معصومه (س)</option>
      <option value="https://heyatonline.ir/hm/5/">حرم امام حسین (ع) - گنبد</option>
      <option value="https://heyatonline.ir/hm/15/">حرم امام حسین (ع) - روضه</option>
      <option value="https://heyatonline.ir/hm/6/">حرم حضرت عباس (ع)</option>
      <option value="https://heyatonline.ir/hm/7/">مسجد کوفه</option>
      <option value="https://heyatonline.ir/hm/8/">مسجد سهله</option>
      <option value="https://heyatonline.ir/hm/9/">عتبات عالیات - کاظمین</option>
    </select>
  </div>

  <div class="haram-stream-container">
    <iframe id="haramStreamIframe" 
            src="" 
            frameborder="0" 
            allow="autoplay; encrypted-media" 
            allowfullscreen 
            loading="lazy"
            referrerpolicy="no-referrer">
    </iframe>
    <div id="haramStreamPlaceholder">
        <i class="fas fa-mosque"></i>
        <p>لطفاً یک حرم را انتخاب کنید تا پخش زنده نمایش داده شود.</p>
    </div>
  </div>
  <p style="text-align: center; font-size: 0.8rem; color: #aaa; margin-top: 15px;">
    پخش زنده از سرویس هیئت آنلاین. در صورت عدم نمایش، لطفاً به اینترنت متصل باشید و فیلترشکن را خاموش کنید.
  </p>
</div>

<div class="overlay" id="feedOverlay">
  <div class="overlay-header">
    <h3 class="overlay-title">اطلاع‌رسانی</h3>
    <button class="close-overlay" onclick="toggleOverlay('feedOverlay')">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="feed-container" id="feedContainer">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>در حال بارگذاری پست‌ها...</p>
    </div>
  </div>
  
  <div class="add-post-btn" id="addPostBtn" style="display:none">
    <button onclick="showPostForm()"><i class="fas fa-plus"></i> پست جدید</button>
  </div>
</div>

<div class="overlay" id="postFormOverlay" style="display:none">
  <div class="overlay-header">
    <h3 class="overlay-title">ایجاد پست جدید</h3>
    <button class="close-overlay" onclick="toggleOverlay('postFormOverlay')">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <form id="newPostForm">
    <input type="text" placeholder="عنوان پست" required>
    <textarea placeholder="متن پست" required></textarea>
    <div class="image-upload" style="display: flex; align-items: center; gap: 10px; background-color: var(--card-bg); padding: 10px; border-radius: 8px; border: 1px dashed var(--border-color);">
      <label for="postImage" style="cursor: pointer; display: flex; align-items: center; gap: 5px; color: var(--secondary-color);">
        <i class="fas fa-image"></i> انتخاب تصویر
      </label>
      <input type="file" id="postImage" accept="image/*" style="display: none;">
      <span id="imageFileName" style="font-size: 0.9rem; color: #aaa;">فایلی انتخاب نشده</span>
    </div>
    <button type="submit"><i class="fas fa-paper-plane"></i> انتشار</button>
  </form>
</div>

<button class="admin-activator" onclick="enableAdminMode()">
  <i class="fas fa-user-shield"></i>
</button>

<script>
  // Dynamic CSS variables for hover effects (for SCSS like darken function)
  document.documentElement.style.setProperty('--primary-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--primary-color')));
  document.documentElement.style.setProperty('--secondary-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--secondary-color')));
  document.documentElement.style.setProperty('--bg-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--bg-color')));

  function hexToRgb(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `${r}, ${g}, ${b}`;
  }

  // Back to top button visibility
  window.addEventListener('scroll', function() {
    const backToTop = document.querySelector('.back-to-top');
    if (window.scrollY > 300) {
      backToTop.classList.add('visible');
    } else {
      backToTop.classList.remove('visible');
    }
  });

  // Theme toggle functionality
  function toggleTheme() {
    document.body.classList.toggle('light-mode');
    localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    // Update RGB values for dynamic CSS variables
    document.documentElement.style.setProperty('--primary-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--primary-color')));
    document.documentElement.style.setProperty('--secondary-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--secondary-color')));
    document.documentElement.style.setProperty('--bg-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--bg-color')));
  }

  // Remove referrer info from iframes
  document.querySelectorAll('iframe').forEach(iframe => {
    iframe.setAttribute('referrerpolicy', 'no-referrer');
  });

  // Search functionality
  document.querySelector('.search-box button').addEventListener('click', function() {
    const searchTerm = document.querySelector('.search-box input').value.trim();
    if (searchTerm !== '') {
      alert('نتایج جستجو برای: ' + searchTerm);
      // In a real application, you would implement actual search logic here.
    }
  });

  document.querySelector('.search-box input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const searchTerm = this.value.trim();
      if (searchTerm !== '') {
        alert('نتایج جستجو برای: ' + searchTerm);
        // In a real application, you would implement actual search logic here.
      }
    }
  });

  let currentDate = new Date(); // Gregorian date for Aladhan API
  let currentSurah = null;
  let showPersianTranslations = true;
  let showEnglishTranslations = true;
  let isAdmin = false; 

  // Toggle overlay visibility
  function toggleOverlay(id) {
      document.querySelectorAll('.overlay').forEach(el => {
          if (el.id !== id) {
              el.classList.remove('show');
              // Specific cleanup for iframes in other overlays
              if (el.id === 'haramOnlineOverlay') {
                  document.getElementById('haramStreamIframe').src = '';
                  document.getElementById('haramStreamIframe').style.display = 'none';
                  document.getElementById('haramStreamPlaceholder').style.display = 'flex';
              }
          }
      });
      
      const overlay = document.getElementById(id);
      overlay.classList.toggle('show');

      // If haramOnlineOverlay is opened and a stream is selected, load it
      if (id === 'haramOnlineOverlay' && overlay.classList.contains('show')) {
          const haramSelect = document.getElementById('haramSelect');
          if (haramSelect.value) {
              loadHaramStream(haramSelect.value);
          }
      }
  }

  function showQuranSection() {
    toggleOverlay('quranOverlay');
    if (!document.getElementById('surahSelectInner').options.length) {
      loadSurahList();
    }
    // Load first surah by default if nothing is selected
    if (document.getElementById('surahSelectInner').value === "") {
        loadSurah(1); // Load Surah Al-Fatiha by default
    }
  }

  function showCalendar() {
    toggleOverlay('calendarOverlay');
    updateCalendar();
    fetchPrayerTimes(); 
  }

  // Load surah list for Quran section
  const surahNames = [
    "الفاتحة","البقرة","آل عمران","النساء","المائدة","الأنعام","الأعراف","الأنفال","التوبة","يونس","هود","يوسف","الرعد",
    "إبراهيم","الحجر","النحل","الإسراء","الكهف","مريم","طه","الأنبياء","الحج","المؤمنون","النور","الفرقان","الشعراء","النمل",
    "القصص","العنكبوت","الروم","لقمان","السجدة","الأحزاب","سبأ","فاطر","يس","الصافات","ص","الزمر","غافر","فصلت","الشورى",
    "الزخرف","الدخان","الجاثية","الأحقاف","محمد","الفتح","الحجرات","ق","الذاريات","الطور","النجم","القمر","الرحمن","الواقعة",
    "الحديد","المجادلة","الحشر","الممتحنة","الصف","الجمعة","المنافقون","التغابن","الطلاق","التحريم","الملك","القلم","الحاقة",
    "المعارج","نوح","الجن","المزمل","المدثر","القيامة","الإنسان","المرسلات","النبأ","النازعات","عبس","التكوير","الانفطار",
    "المطففين","الانشقاق","البروج","الطارق","الأعلى","الغاشية","الفجر","البلد","الشمس","الليل","الضحى","الشرح","التين",
    "العلق","القدر","البينة","الزلزلة","العاديات","القارعة","التكاثر","العصر","الهمزة","الفيل","قريش","الماعون","الكوثر",
    "الكافرون","النصر","المسد","الإخلاص","الفلق","الناس"
  ];
  
  const surahNamesPersian = [
      "حمد","بقره","آل عمران","نساء","مائده","انعام","اعراف","انفال","توبه","یونس","هود","یوسف","رعد",
      "ابراهیم","حجر","نحل","اسراء","کهف","مریم","طه","انبیاء","حج","مؤمنون","نور","فرقان","شعراء","نمل",
      "قصص","عنکبوت","روم","لقمان","سجده","احزاب","سبأ","فاطر","یس","صافات","ص","زمر","غافر","فصلت","شوری",
      "زخرف","دخان","جاثیه","احقاف","محمد","فتح","حجرات","ق","ذاریات","طور","نجم","قمر","رحمن","واقعه",
      "حدید","مجادله","حشر","ممتحنه","صف","جمعه","منافقون","تغابن","طلاق","تحریم","ملک","قلم","حاقه",
      "معارج","نوح","جن","مزمل","مدثر","قیامه","انسان","مرسلات","نبأ","نازعات","عبس","تکویر","انفطار",
      "مطففین","انشقاق","بروج","طارق","اعلی","غاشیه","فجر","بلد","شمس","لیل","ضحی","شرح","تین",
      "علق","قدر","بینه","زلزله","عادیات","قارعه","تکاثر","عصر","همزه","فیل","قریش","ماعون","کوثر",
      "کافرون","نصر","مسد","اخلاص","فلق","ناس"
  ];

  async function loadSurahList() {
    try {
      const select = document.getElementById('surahSelectInner'); 
      for (let i = 0; i < 114; i++) {
        const option = document.createElement('option');
        option.value = i + 1;
        option.textContent = `سوره ${surahNames[i]} (${i + 1})`;
        select.appendChild(option);
      }
      
      const juzSelect = document.getElementById('juzSelect');
      for (let i = 1; i <= 30; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `جزء ${i}`;
        juzSelect.appendChild(option);
      }
    } catch (error) {
      console.error('Error loading surah list:', error);
      document.getElementById('quranContent').innerHTML = '<p class="text-center">خطا در بارگذاری سوره‌ها. لطفاً دوباره تلاش کنید.</p>';
    }
  }

  // Load a specific surah
  async function loadSurah(surahId) {
    if (!surahId) return;
    
    const quranContent = document.getElementById('quranContent');
    quranContent.innerHTML = `
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>در حال بارگذاری سوره...</p>
      </div>
    `;
    
    try {
      const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahId}/editions/ar.alafasy,fa.ghomayshi,en.sahih`).then(r => r.json());
      const arabicData = response.data[0];
      const farsiData = response.data[1];
      const englishData = response.data[2];

      const arabicAyahs = arabicData.ayahs;
      const farsiAyahs = farsiData.ayahs;
      const englishAyahs = englishData.ayahs;
      const surahName = arabicData.name;
      const verseCount = arabicData.numberOfAyahs;
      
      let html = `<div class="surah-header">
        <h4 class="secondary-text">${surahName}</h4>
        <p>تعداد آیات: ${verseCount}</p>
      </div>`;
      
      for (let i = 0; i < arabicAyahs.length; i++) {
        const ar = arabicAyahs[i];
        const fa = farsiAyahs[i];
        const en = englishAyahs[i];

        html += `
          <div class="verse-container quran-verse" id="verse-${ar.numberInSurah}">
            <strong>آیه ${ar.numberInSurah}</strong>
            <p class="verse-arabic">
              ${ar.text.replace(/([ۖ-ۚ])/g, '<span class="primary-text">$1</span>')}
            </p>
            ${showPersianTranslations ? `<p class="verse-translation"><b>ترجمه فارسی:</b> ${fa.text}</p>` : ''}
            ${showEnglishTranslations ? `<p class="verse-english-translation"><b>English Translation:</b> ${en.text}</p>` : ''}
            <audio controls src="${ar.audio}" style="width: 100%; margin-top: 10px;"></audio>
          </div>
        `;
      }
      
      quranContent.innerHTML = html;
      currentSurah = surahId;
    } catch (error) {
      console.error('Error loading surah:', error);
      quranContent.innerHTML = '<p class="text-center">خطا در بارگذاری محتوای سوره. لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.</p>';
    }
  }

  // Load a specific juz
  async function loadJuz(juzNumber) {
    if (!juzNumber) return;
    
    const quranContent = document.getElementById('quranContent');
    quranContent.innerHTML = `
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>در حال بارگذاری جزء ${juzNumber}...</p>
      </div>
    `;
    
    try {
      const response = await fetch(`https://api.alquran.cloud/v1/juz/${juzNumber}/editions/ar.alafasy,fa.ghomayshi,en.sahih`).then(r => r.json());
      const arabicData = response.data[0];
      const farsiData = response.data[1];
      const englishData = response.data[2];
      
      let html = `<h4 class="secondary-text text-center">جزء ${juzNumber}</h4>`;
      
      for (let i = 0; i < arabicData.ayahs.length; i++) {
        const ar = arabicData.ayahs[i];
        const fa = farsiData.ayahs[i];
        const en = englishData.ayahs[i];

        html += `
          <div class="verse-container quran-verse">
            <strong>سوره ${surahNames[ar.surah.number - 1]} - آیه ${ar.numberInSurah}</strong>
            <p class="verse-arabic">
              ${ar.text.replace(/([ۖ-ۚ])/g, '<span class="primary-text">$1</span>')}
            </p>
            ${showPersianTranslations ? `<p class="verse-translation"><b>ترجمه فارسی:</b> ${fa.text}</p>` : ''}
            ${showEnglishTranslations ? `<p class="verse-english-translation"><b>English Translation:</b> ${en.text}</p>` : ''}
            <audio controls src="${ar.audio}" style="width: 100%; margin-top: 10px;"></audio>
          </div>
        `;
      }
      
      quranContent.innerHTML = html;
    } catch (error) {
      console.error('Error loading juz:', error);
      quranContent.innerHTML = '<p class="text-center">خطا در بارگذاری جزء. لطفاً دوباره تلاش کنید.</p>';
    }
  }
  
  // Helper function to find surah number by its Persian name
  function findSurahNumberByName(name) {
      const normalizedName = name.trim();
      const index = surahNamesPersian.indexOf(normalizedName);
      return index !== -1 ? index + 1 : null;
  }

  // Load a specific verse by surah and ayah number
  async function loadSpecificVerse(surahNumber, ayahNumber) {
    const quranContent = document.getElementById('quranContent');
    quranContent.innerHTML = `
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>در حال بارگذاری آیه ${ayahNumber} سوره ${surahNames[surahNumber-1]}...</p>
      </div>
    `;
    
    try {
        const response = await fetch(`https://api.alquran.cloud/v1/ayah/${surahNumber}:${ayahNumber}/editions/ar.alafasy,fa.ghomayshi,en.sahih`).then(r => r.json());
        
        if (response.code !== 200) {
            throw new Error(response.data || "آیه مورد نظر یافت نشد.");
        }

        const ar = response.data[0];
        const fa = response.data[1];
        const en = response.data[2];
        
        let html = `<h4 class="secondary-text text-center">آیه ${ayahNumber} سوره ${ar.surah.name}</h4>`;
        html += `
          <div class="verse-container quran-verse" id="verse-${ar.numberInSurah}">
            <strong>آیه ${ar.numberInSurah}</strong>
            <p class="verse-arabic">
              ${ar.text.replace(/([ۖ-ۚ])/g, '<span class="primary-text">$1</span>')}
            </p>
            ${showPersianTranslations ? `<p class="verse-translation"><b>ترجمه فارسی:</b> ${fa.text}</p>` : ''}
            ${showEnglishTranslations ? `<p class="verse-english-translation"><b>English Translation:</b> ${en.text}</p>` : ''}
            <audio controls src="${ar.audio}" style="width: 100%; margin-top: 10px;"></audio>
          </div>
        `;
        
        quranContent.innerHTML = html;
    } catch (error) {
        console.error('Error loading specific verse:', error);
        quranContent.innerHTML = `<p class="text-center">خطا در بارگذاری آیه. ممکن است شماره آیه در این سوره موجود نباشد.</p><p class="text-center">${error.message}</p>`;
    }
  }

  // Search in Quran (handles text, 'surah name ayah', and 'surah:ayah')
  async function searchInQuran() {
    const query = document.getElementById('quranSearch').value.trim();
    if (!query) {
      alert('لطفاً عبارتی برای جستجو وارد کنید.');
      return;
    }
    
    const quranContent = document.getElementById('quranContent');
    quranContent.innerHTML = `
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i>
        <p>در حال جستجو برای "${query}"...</p>
      </div>
    `;

    // Pattern 1: Surah Name + Ayah Number (e.g., بقره 5)
    const nameVersePattern = /^(?:سوره\s*)?([^\d\s]+)\s*(?:آیه\s*)?(\d+)$/;
    const nameVerseMatch = query.match(nameVersePattern);
    if (nameVerseMatch) {
        const surahName = nameVerseMatch[1];
        const ayahNumber = nameVerseMatch[2];
        const surahNumber = findSurahNumberByName(surahName);
        if (surahNumber) {
            loadSpecificVerse(surahNumber, ayahNumber);
            return;
        }
    }

    // Pattern 2: Surah Number + Ayah Number (e.g., 2:5 or 2 5)
    const numVersePattern = /^(\d+)[\s:.](\d+)$/;
    const numVerseMatch = query.match(numVersePattern);
    if (numVerseMatch) {
        const surahNumber = numVerseMatch[1];
        const ayahNumber = numVerseMatch[2];
        loadSpecificVerse(surahNumber, ayahNumber);
        return;
    }
    
    // Fallback to full-text search
    try {
      const response = await fetch(`https://api.alquran.cloud/v1/search/${encodeURIComponent(query)}/all/editions/ar.alafasy,fa.ghomayshi,en.sahih`).then(r => r.json());
      
      const arabicMatches = response.data[0].matches;
      const farsiMatches = response.data[1].matches;
      const englishMatches = response.data[2].matches;

      if (arabicMatches.length === 0) {
        quranContent.innerHTML = '<p class="text-center">نتیجه‌ای یافت نشد.</p>';
        return;
      }
      
      let html = `<h4 class="secondary-text text-center">نتایج جستجو برای "${query}"</h4>`;
      
      arabicMatches.forEach((match, index) => {
        const farsiMatch = farsiMatches[index];
        const englishMatch = englishMatches[index];
        
        let highlightedArabic = match.text.replace(new RegExp(query, 'gi'), `<span class="highlight">$&</span>`);
        let highlightedFarsiTranslation = farsiMatch ? farsiMatch.text.replace(new RegExp(query, 'gi'), `<span class="highlight">$&</span>`) : 'ترجمه فارسی در دسترس نیست.';
        let highlightedEnglishTranslation = englishMatch ? englishMatch.text.replace(new RegExp(query, 'gi'), `<span class="highlight">$&</span>`) : 'English translation not available.';

        html += `
          <div class="verse-container quran-verse" id="search-${match.number}">
            <strong>سوره ${surahNames[match.surah.number - 1]} - آیه ${match.numberInSurah}</strong>
            <p class="verse-arabic">
              ${highlightedArabic.replace(/([ۖ-ۚ])/g, '<span class="primary-text">$1</span>')}
            </p>
            ${showPersianTranslations ? `<p class="verse-translation"><b>ترجمه فارسی:</b> ${highlightedFarsiTranslation}</p>` : ''}
            ${showEnglishTranslations ? `<p class="verse-english-translation"><b>English Translation:</b> ${highlightedEnglishTranslation}</p>` : ''}
            <audio controls src="${match.audio}" style="width: 100%; margin-top: 10px;"></audio>
          </div>
        `;
      });
      
      quranContent.innerHTML = html;
      
    } catch (error) {
      console.error('Error in Quran search:', error);
      quranContent.innerHTML = '<p class="text-center">خطا در انجام جستجو. لطفاً دوباره تلاش کنید.</p>';
    }
  }


  // Toggle translation visibility (Persian or English)
  function toggleTranslation(language) {
    if (language === 'persian') {
      showPersianTranslations = !showPersianTranslations;
      document.querySelectorAll('.verse-translation').forEach(el => {
        el.style.display = showPersianTranslations ? 'block' : 'none';
      });
      alert(`نمایش ترجمه فارسی: ${showPersianTranslations ? 'فعال' : 'غیرفعال'}`);
    } else if (language === 'english') {
      showEnglishTranslations = !showEnglishTranslations;
      document.querySelectorAll('.verse-english-translation').forEach(el => {
        el.style.display = showEnglishTranslations ? 'block' : 'none';
      });
      alert(`Display English Translation: ${showEnglishTranslations ? 'Enabled' : 'Disabled'}`);
    }
  }

  // Placeholder for audio playback (the audio element is already there)
  function toggleAudio() {
    alert('پخش صوتی آیات به صورت پیش‌فرض در هر آیه وجود دارد.');
  }

  // Placeholder for bookmarking
  function bookmarkVerse() {
    alert('قابلیت ذخیره آیه در حال توسعه است.');
  }

  // Calendar and Prayer Times
  function updateCalendar() {
    // This part of the calendar remains Gregorian as Aladhan API provides Gregorian dates.
    // For a Persian calendar, a dedicated JS library for Jalaali/Solar conversions is needed.
    const gregorianMonthNames = ["January", "February", "March", "April", "May", "June", 
                       "July", "August", "September", "October", "November", "December"];
    
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth();
    
    document.getElementById('currentMonth').textContent = 
      `${gregorianMonthNames[currentMonth]} ${currentYear}`;
    
    const firstDayOfWeek = new Date(currentDate.getFullYear(), currentMonth, 1).getDay(); // 0 for Sunday, 6 for Saturday
    const daysInMonth = new Date(currentDate.getFullYear(), currentMonth + 1, 0).getDate();
    
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';
    
    // Days of the week in Persian, starting from Saturday (شنبه)
    const dayNames = ["ش", "ی", "د", "س", "چ", "پ", "ج"]; 
    dayNames.forEach(day => {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day-name';
      dayElement.textContent = day;
      calendarGrid.appendChild(dayElement);
    });
    
    // Determine the offset for the first day of the month based on Saturday start (Day 6 in JS is Saturday)
    // If firstDayOfWeek is Sunday (0), offset is 6. If Monday (1), offset is 0.
    const startDayOffset = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1; 

    for (let i = 0; i < startDayOffset; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.className = 'calendar-day other-month';
      calendarGrid.appendChild(emptyDay);
    }
    
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
      const dayElement = document.createElement('div');
      dayElement.className = 'calendar-day';
      dayElement.textContent = day;
      
      if (currentDate.getFullYear() === today.getFullYear() && 
          currentMonth === today.getMonth() && 
          day === today.getDate()) {
        dayElement.classList.add('today');
      }
      
      calendarGrid.appendChild(dayElement);
    }
  }

  // Change month in calendar
  function changeMonth(offset) {
    currentDate.setMonth(currentDate.getMonth() + offset);
    updateCalendar();
    fetchPrayerTimes();
  }

  // Fetch prayer times using Aladhan API
  async function fetchPrayerTimes() {
    const city = document.getElementById('cityInput').value.trim();
    const country = document.getElementById('countryInput').value.trim();

    if (!city || !country) {
        alert('لطفاً نام شهر و کشور را وارد کنید.');
        document.getElementById('prayerTimes').innerHTML = '<p class="text-center">لطفاً شهر و کشور را وارد کنید.</p>';
        return;
    }

    const prayerTimesContainer = document.getElementById('prayerTimes');
    prayerTimesContainer.innerHTML = `
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>در حال دریافت اوقات شرعی...</p>
        </div>
    `;

    const date = `${currentDate.getDate()}-${currentDate.getMonth() + 1}-${currentDate.getFullYear()}`;
    const method = 8; // Islamic Society of North America (ISNA) - common method
    
    try {
        const response = await fetch(`https://api.aladhan.com/v1/timingsByCity/${date}?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=${method}`);
        
        if (!response.ok) {
            // Attempt to read error message from response body if available
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        
        const data = await response.json();
        
        if (data.code === 200 && data.status === 'OK') {
            const timings = data.data.timings;
            prayerTimesContainer.innerHTML = `
                <div class="prayer-time"><span>فجر</span><span id="fajr">${timings.Fajr}</span></div>
                <div class="prayer-time"><span>طلوع</span><span id="sunrise">${timings.Sunrise}</span></div>
                <div class="prayer-time"><span>ظهر</span><span id="dhuhr">${timings.Dhuhr}</span></div>
                <div class="prayer-time"><span>عصر</span><span id="asr">${timings.Asr}</span></div>
                <div class="prayer-time"><span>غروب</span><span id="maghrib">${timings.Maghrib}</span></div>
                <div class="prayer-time"><span>عشاء</span><span id="isha">${timings.Isha}</span></div>
                <div class="prayer-time"><span>نیمه‌شب</span><span id="midnight">${timings.Midnight}</span></div>
            `;
        } else {
            console.error('API response error:', data);
            prayerTimesContainer.innerHTML = `<p class="text-center">اوقات شرعی برای این شهر و کشور یافت نشد یا خطایی رخ داد: ${data.status || 'نامشخص'}</p>`;
        }
    } catch (error) {
        console.error('Error fetching prayer times:', error);
        prayerTimesContainer.innerHTML = `<p class="text-center">خطا در دریافت اوقات شرعی. (ممکن است به دلیل <strong class="primary-text">خطای CORS</strong> یا مشکل در اتصال باشد). لطفاً از طریق یک سرور واسط (Backend Proxy) اقدام کنید.</p>`;
    }
  }

  // Admin mode activation
  function enableAdminMode() {
    const password = prompt("برای فعالسازی حالت مدیریت، رمز عبور را وارد کنید:");
    if (password === "admin123") { 
      isAdmin = true;
      document.getElementById('addPostBtn').style.display = 'block';
      alert('حالت مدیریت فعال شد. اکنون می‌توانید مطالب جدید به بخش اطلاع‌رسانی اضافه کنید.');
      
      const activator = document.querySelector('.admin-activator');
      if (activator) activator.style.display = 'none';
    } else {
      alert("رمز عبور اشتباه است.");
      isAdmin = false;
    }
  }

  // Scroll to top
  function scrollToTop() {
    window.scrollTo({top: 0, behavior: 'smooth'});
  }

  // Toggle feed overlay
  function toggleFeed() {
    toggleOverlay('feedOverlay');
    loadFeedPosts();
    document.getElementById('addPostBtn').style.display = isAdmin ? 'block' : 'none';
  }

  // Load feed posts (simulated data)
  async function loadFeedPosts() {
    try {
      const posts = [
        {
          id: 1,
          title: "برنامه‌های ویژه دهه اول محرم",
          content: "مراسم عزاداری شب‌های محرم از ساعت 20 الی 23:30 در حسینیه برگزار می‌شود.",
          date: "2025-07-01T18:30:00Z",
          image: "https://via.placeholder.com/400x200/800000/FFFFFF?text=محرم" 
        },
        {
          id: 2,
          title: "جلسه تفسیر قرآن",
          content: "جلسه تفسیر سوره یس با حضور حجت‌الاسلام محمدی هر پنجشنبه ساعت 17 برگزار می‌شود.",
          date: "2025-06-25T14:00:00Z"
        },
        {
          id: 3,
          title: "مراسم میلاد امام رضا (ع)",
          content: "مراسم جشن میلاد امام رضا (ع) روز پنجشنبه 5 مرداد از ساعت 19:30 در حسینیه برگزار می‌شود.",
          date: "2025-07-24T16:00:00Z",
          image: "https://via.placeholder.com/400x200/800000/FFFFFF?text=میلاد+امام+رضا" 
        }
      ];
      
      let html = '';
      posts.sort((a, b) => new Date(b.date) - new Date(a.date));

      posts.forEach(post => {
        html += `
          <div class="feed-post">
            <div class="post-header">
              <div>
                <h4>${post.title}</h4>
                <small>${formatPostDate(post.date)}</small>
              </div>
            </div>
            <div class="post-content">${post.content}</div>
            ${post.image ? `<img src="${post.image}" class="post-image" alt="${post.title}">` : ''}
          </div>
        `;
      });
      
      document.getElementById('feedContainer').innerHTML = html;
    } catch (error) {
      console.error('Error loading posts:', error);
      document.getElementById('feedContainer').innerHTML = '<p class="text-center">خطا در بارگذاری اطلاعیه‌ها. لطفاً دوباره تلاش کنید.</p>';
    }
  }

  function formatPostDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date; 
    
    if (diff < 60 * 1000) return 'همین الان'; 
    if (diff < 60 * 60 * 1000) return `${Math.floor(diff / (60 * 1000))} دقیقه پیش`; 
    if (diff < 24 * 60 * 60 * 1000) return `${Math.floor(diff / (60 * 60 * 1000))} ساعت پیش`; 
    
    // Fallback to Persian date format if Intl.DateTimeFormat is not fully supported or preferred
    try {
        return new Intl.DateTimeFormat('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' }).format(date);
    } catch (e) {
        return date.toLocaleDateString('fa-IR');
    }
  }

  // Show post creation form
  function showPostForm() {
    if (isAdmin) { 
      toggleOverlay('postFormOverlay');
      document.getElementById('imageFileName').textContent = 'فایلی انتخاب نشده'; // Reset image file name
    } else {
      alert("شما مجوز ایجاد پست جدید را ندارید.");
    }
  }

  // Show Haram Online section
  function showHaramOnlineSection() {
    toggleOverlay('haramOnlineOverlay');
    const haramSelect = document.getElementById('haramSelect');
    if (haramSelect.value) {
      loadHaramStream(haramSelect.value);
    } else {
      document.getElementById('haramStreamPlaceholder').style.display = 'flex';
      document.getElementById('haramStreamIframe').src = '';
    }
  }

  // Load Haram stream
  function loadHaramStream(url) {
    const iframe = document.getElementById('haramStreamIframe');
    const placeholder = document.getElementById('haramStreamPlaceholder');
    if (url) {
      iframe.src = url;
      iframe.style.display = 'block'; 
      placeholder.style.display = 'none'; 
    } else {
      iframe.src = '';
      iframe.style.display = 'none'; 
      placeholder.style.display = 'flex'; 
    }
  }

  // Initial setup on page load
  window.addEventListener('DOMContentLoaded', function() {
    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      document.body.classList.add('light-mode');
    }
    // Update RGB values after initial theme load
    document.documentElement.style.setProperty('--primary-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--primary-color')));
    document.documentElement.style.setProperty('--secondary-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--secondary-color')));
    document.documentElement.style.setProperty('--bg-color-rgb', hexToRgb(getComputedStyle(document.documentElement).getPropertyValue('--bg-color')));
    
    // Quran search with Enter key
    document.getElementById('quranSearch').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchInQuran();
      }
    });
    
    // New post form submission
    document.getElementById('newPostForm')?.addEventListener('submit', function(e) {
      e.preventDefault();
      const title = this.elements[0].value;
      const content = this.elements[1].value;
      const imageFile = document.getElementById('postImage').files[0];
      
      let imageUrl = '';
      if (imageFile) {
          imageUrl = URL.createObjectURL(imageFile);
      }

      const newPost = {
          id: Date.now(), 
          title: title,
          content: content,
          date: new Date().toISOString(),
          image: imageUrl
      };

      const feedContainer = document.getElementById('feedContainer');
      const postElement = document.createElement('div');
      postElement.className = 'feed-post';
      postElement.innerHTML = `
        <div class="post-header">
            <div>
                <h4>${newPost.title}</h4>
                <small>${formatPostDate(newPost.date)}</small>
            </div>
        </div>
        <div class="post-content">${newPost.content}</div>
        ${newPost.image ? `<img src="${newPost.image}" class="post-image" alt="${newPost.title}">` : ''}
      `;
      feedContainer.prepend(postElement); 

      alert('پست جدید با موفقیت ایجاد شد!');
      this.reset();
      toggleOverlay('postFormOverlay');
      if (imageUrl) {
          URL.revokeObjectURL(imageUrl);
      }
    });

    // Display selected image file name in post form
    document.getElementById('postImage').addEventListener('change', function() {
        const fileName = this.files[0] ? this.files[0].name : 'فایلی انتخاب نشده';
        document.getElementById('imageFileName').textContent = fileName;
    });

    loadSurahList(); 
    // Initial load of calendar and prayer times (defaults to current date and Tehran, Iran)
    updateCalendar(); 
    fetchPrayerTimes(); 
  });

  // Simple darken function for CSS variable calculation (client-side simulation)
  function darken(color, percent) {
      let f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=(f>>8)&0x00FF,B=f&0x0000FF;
      return "#"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1);
  }
</script>
</body>
</html>